<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEP Holistic Progress Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;500;700&display=swap');

        body { background-color: #f3f4f6; font-family: 'Roboto', sans-serif; }
        
        /* --- PAPER SHEET --- */
        .paper-sheet {
            background: white; width: 210mm; min-height: 297mm; padding: 10mm 15mm; margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.1); position: relative; font-family: 'Noto Serif', serif;
            border: 1px solid #e5e7eb; color: #1e293b;
        }

        /* --- TABLE --- */
        .marks-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 11px; }
        .marks-table th, .marks-table td { border: 1px solid #334155; padding: 5px; text-align: center; }
        .marks-table th { background-color: #f1f5f9; font-weight: bold; text-transform: uppercase; font-size: 10px; color: #334155; }
        .text-left-align { text-align: left !important; padding-left: 8px !important; }

        /* --- NEP UI --- */
        .section-header {
            background-color: #1e293b; color: white; padding: 4px 10px; font-size: 11px; font-weight: bold;
            text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; border-radius: 2px;
            display: flex; justify-content: space-between; align-items: center;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px 20px; font-size: 12px; margin-bottom: 15px; }
        .nep-box { border: 1px solid #94a3b8; padding: 8px; border-radius: 4px; background: #f8fafc; height: 100%; display: flex; flex-direction: column; }
        .nep-label { font-size: 10px; font-weight: bold; color: #475569; text-transform: uppercase; display: block; border-bottom: 1px solid #e2e8f0; margin-bottom: 4px; padding-bottom: 2px; }
        .nep-content { font-size: 11px; line-height: 1.4; font-style: italic; flex-grow: 1; }

        /* --- BADGES --- */
        .badge { padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; display: inline-block; border: 1px solid rgba(0,0,0,0.1); }
        .bg-begin { background-color: #fee2e2; color: #991b1b; } 
        .bg-dev { background-color: #fef3c7; color: #92400e; }   
        .bg-prof { background-color: #d1fae5; color: #065f46; }  
        .bg-exem { background-color: #dbeafe; color: #1e40af; }  

        /* --- SIGNATURES --- */
        .signature-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; margin-top: 30px; text-align: center; gap: 20px; }
        .sign-line { border-top: 1px solid #000; margin: 0 15px; padding-top: 5px; font-weight: bold; font-size: 11px; }

        /* --- PRINT --- */
        @media print {
            @page { margin: 0; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            #cardsContainer { display: block !important; margin: 0; }
            .paper-sheet { box-shadow: none; margin: 0; width: 100%; height: 296mm; padding: 10mm 15mm; border: none; break-after: page; page-break-after: always; }
            .section-header { background-color: #1e293b !important; color: white !important; }
            .nep-box { background-color: #f8fafc !important; }
        }
    </style>
</head>
<body>
    <div class="no-print bg-white border-b shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-file-contract text-indigo-600 text-2xl"></i>
                        <h1 class="text-xl font-bold text-gray-800">NEP HPC Generator</h1>
                    </div>
                    <div class="flex gap-2">
                        <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-gray-700 transition flex items-center text-sm font-medium decoration-0">
                            <i class="fas fa-home mr-2"></i> Home
                        </a>
                        <a href="db_manager.html" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow-sm hover:bg-indigo-700 transition flex items-center text-sm font-medium decoration-0">
                            <i class="fas fa-database mr-2"></i> Manage DB
                        </a>
                    </div>
                </div>

                <div class="flex justify-center">
                    <div class="flex flex-wrap w-full md:w-auto gap-2 items-center bg-gray-50 p-2 rounded-lg border">
                        <div class="flex flex-col text-xs"><label class="font-bold text-gray-500 ml-1">Session</label><select id="sessionFilter" class="border rounded-md px-2 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white"></select></div>
                        <div class="flex flex-col text-xs">
                            <label class="font-bold text-gray-500 ml-1">Class</label>
                            <select id="classFilter" onchange="updateSearchOptions()" class="border rounded-md px-2 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                <option value="All">All Classes</option>
                                <optgroup label="Foundational"><option value="LKG">LKG</option><option value="UKG">UKG</option><option value="1st">1st</option><option value="2nd">2nd</option></optgroup>
                                <optgroup label="Preparatory"><option value="3rd">3rd</option><option value="4th">4th</option><option value="5th">5th</option></optgroup>
                                <optgroup label="Middle"><option value="6th">6th</option><option value="7th">7th</option><option value="8th">8th</option></optgroup>
                                <optgroup label="Secondary"><option value="9th">9th</option><option value="10th">10th</option></optgroup>
                            </select>
                        </div>
                        <div class="flex flex-col text-xs"><label class="font-bold text-gray-500 ml-1">Search By</label><select id="searchType" class="border rounded-md px-2 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" onchange="updateSearchOptions()"><option value="admNo">Admission No</option><option value="studentId">Student ID</option><option value="rollNo">Roll No</option><option value="name">Name</option></select></div>
                        <div class="flex flex-col text-xs flex-1 min-w-[200px]"><label class="font-bold text-gray-500 ml-1">Value</label><input type="text" id="searchInput" list="dynamicOptions" placeholder="Select or Type..." class="w-full border rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" onkeypress="handleEnter(event)" onfocus="updateSearchOptions()"><datalist id="dynamicOptions"></datalist></div>
                        <button onclick="searchStudent()" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition shadow-sm font-medium"><i class="fas fa-search mr-1"></i> Find</button>
                        <button onclick="printCard()" class="mt-4 bg-gray-800 text-white px-6 py-2 rounded-md hover:bg-gray-900 transition shadow-sm font-medium"><i class="fas fa-print mr-1"></i> Print</button>
                    </div>
                </div>
            </div>
            <div id="statusMsg" class="text-center mt-2 text-sm font-medium h-5 text-red-500"></div>
        </div>
    </div>

    <div class="flex justify-center p-4 print:p-0"><div id="cardsContainer" class="w-full flex flex-col items-center gap-8 print:block"><div id="welcomeScreen" class="text-center mt-20 text-gray-500"><i class="fas fa-shapes text-6xl mb-4 text-gray-300"></i><h2 class="text-2xl font-bold">Holistic Progress Card</h2><p class="mt-2">NEP 2020 Compliant • 360° Assessment</p></div></div></div>

    <script>
        let resultRegister = [];
        let supportedSessions = [];
        let schoolInfo = { name: "Government High School", address: "Department of School Education" };

        window.onload = loadDatabase;

        async function loadDatabase() {
            const statusMsg = document.getElementById('statusMsg');
            try {
                const response = await fetch('students_db_nep.json');
                let data;
                if (response.ok) { data = await response.json(); } 
                else { const res2 = await fetch('students_db.json'); if(!res2.ok) throw new Error("No DB file found"); data = await res2.json(); }

                if (Array.isArray(data)) { resultRegister = data; } 
                else {
                    resultRegister = data.students || [];
                    supportedSessions = data.supported_sessions || ["2023-2024", "2024-2025"];
                    if(data.school_name) schoolInfo.name = data.school_name;
                    if(data.school_department) schoolInfo.address = data.school_department;
                }

                const sessionSelect = document.getElementById('sessionFilter');
                sessionSelect.innerHTML = `<option value="All">All Sessions</option>`;
                supportedSessions.forEach(year => { const opt = document.createElement('option'); opt.value = year; opt.innerText = year; sessionSelect.appendChild(opt); });
                sessionSelect.value = "All";
                
                statusMsg.innerText = "Database loaded successfully.";
                statusMsg.classList.remove('text-red-500'); statusMsg.classList.add('text-green-600');
                updateSearchOptions();
            } catch (error) { statusMsg.innerText = "Error: Could not load 'students_db.json'. Ensure local server is running."; }
        }

        function handleEnter(e) { if(e.key === 'Enter') searchStudent(); }

        function getClassWeight(cls) {
            const mapping = { "10th": 14, "9th": 13, "8th": 12, "7th": 11, "6th": 10, "5th": 9, "4th": 8, "3rd": 7, "2nd": 6, "1st": 5, "UKG": 4, "LKG": 3, "Nursery": 2 };
            return mapping[cls] || 0;
        }

        function updateSearchOptions() {
            const input = document.getElementById('searchInput');
            const datalist = document.getElementById('dynamicOptions');
            const searchType = document.getElementById('searchType').value;
            datalist.innerHTML = '';
            let options = [];
            resultRegister.forEach(s => {
                if(searchType === 'name') options.push(s.name);
                else if(searchType === 'studentId') options.push(s.studentId);
                else if(searchType === 'rollNo') { s.sessions.forEach(sess => options.push(sess.rollNo)); }
                else options.push(s.admNo);
            });
            [...new Set(options)].slice(0, 50).sort().forEach(val => { if(!val) return; const opt = document.createElement('option'); opt.value = val; datalist.appendChild(opt); });
        }

        function searchStudent() {
            const container = document.getElementById('cardsContainer');
            const welcome = document.getElementById('welcomeScreen');
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const type = document.getElementById('searchType').value;
            const sessionFilter = document.getElementById('sessionFilter').value;
            const classFilter = document.getElementById('classFilter').value;

            container.innerHTML = '';
            let matches = [];

            resultRegister.forEach(student => {
                student.sessions.forEach(sess => {
                    let isMatch = true;
                    if(sessionFilter !== "All" && sess.session !== sessionFilter) isMatch = false;
                    if(classFilter !== "All" && sess.class !== classFilter) isMatch = false;
                    if(isMatch && query) {
                        let qMatch = false;
                        if(type === 'name' && student.name.toLowerCase().includes(query)) qMatch = true;
                        else if(type === 'admNo' && student.admNo.toLowerCase().includes(query)) qMatch = true;
                        else if(type === 'studentId' && (student.studentId || '').includes(query)) qMatch = true;
                        else if(type === 'rollNo' && sess.rollNo == query) qMatch = true;
                        if(!qMatch) isMatch = false;
                    }
                    if(isMatch) matches.push({personal: student, session: sess});
                });
            });

            if(matches.length === 0) {
                document.getElementById('statusMsg').innerText = "No records found.";
                document.getElementById('statusMsg').classList.add('text-red-500');
                container.appendChild(welcome); welcome.classList.remove('hidden');
                return;
            }

            welcome.classList.add('hidden');
            document.getElementById('statusMsg').innerText = `Found ${matches.length} record(s).`;
            matches.sort((a, b) => {
                const wA = getClassWeight(a.session.class); const wB = getClassWeight(b.session.class);
                if (wA !== wB) return wB - wA;
                return (parseInt(a.session.rollNo)||0) - (parseInt(b.session.rollNo)||0);
            });
            matches.forEach(m => { container.insertAdjacentHTML('beforeend', generateNEPCard(m.personal, m.session)); });
        }

        function getNEPLevel(percentage) {
            if(percentage >= 85) return { label: "EXEMPLARY", class: "bg-exem" };
            if(percentage >= 65) return { label: "PROFICIENT", class: "bg-prof" };
            if(percentage >= 40) return { label: "DEVELOPING", class: "bg-dev" };
            return { label: "BEGINNING", class: "bg-begin" };
        }

        function getStandardGrade(percentage) {
            if (percentage >= 91) return 'A+'; if (percentage >= 81) return 'A'; if (percentage >= 71) return 'B+';
            if (percentage >= 61) return 'B'; if (percentage >= 51) return 'C+'; if (percentage >= 41) return 'C';
            if (percentage >= 33) return 'D'; return 'E';
        }

        function generateNEPCard(p, s) {
            let grandSum = 0, count = 0, totalMaxMarks = 0;
            const marksRows = (s.subjects || []).map(sub => {
                const total = (sub.fa1||0)+(sub.fa2||0)+(sub.fa3||0)+(sub.sa1||0)+(sub.sa2||0);
                const subMax = sub.max || 100;
                grandSum += total; count++; totalMaxMarks += subMax;
                const percentage = (total / subMax) * 100;
                const level = getNEPLevel(percentage);
                const stdGrade = getStandardGrade(percentage);
                return `<tr>
                    <td class="text-left-align font-semibold text-gray-700">${sub.name}</td>
                    <td>${sub.fa1||'-'}</td><td>${sub.fa2||'-'}</td><td>${sub.fa3||'-'}</td>
                    <td>${sub.sa1||'-'}</td><td>${sub.sa2||'-'}</td>
                    <td>${subMax}</td>
                    <td class="font-bold text-gray-800">${total}</td>
                    <td class="font-bold text-indigo-700">${stdGrade}</td>
                    <td><span class="badge ${level.class}">${level.label}</span></td>
                </tr>`;
            }).join('');
            
            const overallPct = totalMaxMarks > 0 ? (grandSum / totalMaxMarks)*100 : 0;
            const overallLevel = getNEPLevel(overallPct);
            const overallGrade = getStandardGrade(overallPct);
            const att = s.attendance || { working: 0, present: 0 };
            const attPct = (att.working > 0) ? Math.round((att.present/att.working)*100) + '%' : '-';
            const co = s.co_scholastic || {}; const ps = s.personal_social || {}; const reflect = s.reflections || {};
            const cls = s.class; const w = getClassWeight(cls);
            let stage = w <= 4 ? "Foundational" : (w <= 9 ? "Preparatory" : (w <= 12 ? "Middle" : "Secondary"));

            return `
            <div class="paper-sheet">
                <div class="text-center border-b-2 border-black pb-2 mb-4 relative">
                    <h1 class="text-2xl font-bold uppercase tracking-wider text-gray-900 font-serif">${schoolInfo.name}</h1>
                    <p class="text-xs font-semibold text-gray-600 uppercase tracking-widest">${schoolInfo.address}</p>
                    <div class="mt-3 flex flex-col items-center gap-1">
                        <div class="border-2 border-black px-6 py-1 rounded-full text-sm font-bold bg-gray-100 uppercase tracking-wide shadow-sm">Holistic Progress Card</div>
                        <div class="text-[10px] font-bold text-indigo-900 uppercase tracking-widest border border-indigo-200 px-2 py-0.5 rounded bg-indigo-50">${stage} Stage</div>
                    </div>
                </div>
                <div class="info-grid border-b border-gray-200 pb-2">
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Student Name:</span><span class="border-b border-dotted border-gray-400 flex-1 font-bold text-lg">${p.name}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Admission No:</span><span class="border-b border-dotted border-gray-400 flex-1 font-mono font-semibold">${p.admNo}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Class / Sec:</span><span class="border-b border-dotted border-gray-400 flex-1 font-semibold">${s.class} ${s.section ? ' / '+s.section : ''}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Roll No:</span><span class="border-b border-dotted border-gray-400 flex-1 font-semibold">${s.rollNo}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">D.O.B:</span><span class="border-b border-dotted border-gray-400 flex-1">${p.dob}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Student ID:</span><span class="border-b border-dotted border-gray-400 flex-1 font-mono text-xs pt-1">${p.studentId || '-'}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Father's Name:</span><span class="border-b border-dotted border-gray-400 flex-1">${p.father}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Mother's Name:</span><span class="border-b border-dotted border-gray-400 flex-1">${p.mother || '-'}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Session:</span><span class="border-b border-dotted border-gray-400 flex-1 font-semibold text-indigo-900">${s.session}</span></div>
                    <div class="flex"><span class="font-bold w-28 text-gray-600">Attendance:</span><span class="border-b border-dotted border-gray-400 flex-1">${att.present} / ${att.working} <span class="text-xs text-gray-500">(${attPct})</span></span></div>
                </div>
                <div class="section-header"><span>Part A: Scholastic Assessment</span><span class="text-[9px] normal-case opacity-80 tracking-wide">Evaluation of Learning Outcomes</span></div>
                <table class="marks-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="w-1/4 text-left-align">Subjects</th>
                            <th colspan="3">Formative (FA)</th><th colspan="2">Summative (SA)</th>
                            <th rowspan="2" class="w-12">Max<br>Marks</th><th rowspan="2" class="w-12">Obt.<br>Marks</th><th rowspan="2" class="w-12">Grade</th><th rowspan="2" class="w-24">Proficiency<br>Level</th>
                        </tr>
                        <tr><th>FA1</th><th>FA2</th><th>FA3</th><th>SA1</th><th>SA2</th></tr>
                    </thead>
                    <tbody>${marksRows}</tbody>
                    <tfoot>
                        <tr class="bg-gray-50 font-bold">
                            <td class="text-left-align">GRAND TOTAL</td>
                            <td colspan="5" class="text-right pr-2 text-gray-400 text-[10px]">AGGREGATE:</td>
                            <td class="text-base font-bold text-gray-600">${totalMaxMarks}</td>
                            <td class="text-base font-bold text-gray-900">${grandSum}</td>
                            <td class="text-base text-indigo-800">${overallGrade}</td>
                            <td><span class="badge ${overallLevel.class}">${overallLevel.label}</span></td>
                        </tr>
                    </tfoot>
                </table>
                <div class="section-header">Part B: Co-Scholastic & Skills</div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div class="nep-box"><span class="nep-label"><i class="fas fa-palette mr-1"></i> Arts / Education</span><div class="nep-content flex items-center justify-center font-bold text-gray-700 text-sm">${co.arts || 'Participated'}</div></div>
                    <div class="nep-box"><span class="nep-label"><i class="fas fa-running mr-1"></i> Health & PE</span><div class="nep-content flex items-center justify-center font-bold text-gray-700 text-sm">${co.pe || 'Participated'}</div></div>
                    <div class="nep-box"><span class="nep-label"><i class="fas fa-brain mr-1"></i> Life Skills</span><div class="nep-content flex items-center justify-center font-bold text-gray-700 text-sm">${co.values || 'Developing'}</div></div>
                </div>
                <div class="section-header">Part C: Personal & Social Development</div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="nep-box"><span class="nep-label">Socio-Emotional Growth</span><p class="nep-content">"${ps.emotion || 'Shows emotional stability.'}"</p></div>
                    <div class="nep-box"><span class="nep-label">Discipline & Conduct</span><p class="nep-content">"Maintains good discipline and respects school rules."</p></div>
                </div>
                <div class="section-header">Part D: 360° Reflections & Feedback</div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="nep-box bg-white"><span class="nep-label text-indigo-700"><i class="fas fa-user mr-1"></i> Student Self-Reflection</span><p class="nep-content">"${reflect.student_goals || s.nep_self_assess || 'I have improved in my studies.'}"</p></div>
                    <div class="nep-box bg-white"><span class="nep-label text-indigo-700"><i class="fas fa-chalkboard-teacher mr-1"></i> Class Teacher's Remarks</span><div class="nep-content"><div class="font-semibold text-gray-800 mb-1">${s.remarks || 'Promoted to next class.'}</div></div></div>
                    <div class="nep-box bg-white"><span class="nep-label text-indigo-700"><i class="fas fa-user-friends mr-1"></i> Peer Feedback</span><p class="nep-content">"${s.nep_peer_assess || 'Very helpful to classmates.'}"</p></div>
                    <div class="nep-box bg-white"><span class="nep-label text-indigo-700"><i class="fas fa-home mr-1"></i> Parent Feedback</span><p class="nep-content">"${reflect.parent_feedback || 'Satisfied with the school environment.'}"</p></div>
                </div>
                <div class="mt-4 pt-2 border-t border-gray-300 text-[9px] text-gray-500 flex justify-between items-end">
                    <div><strong>Proficiency Key:</strong> <span class="badge bg-begin ml-1">Beginning (<40%)</span><span class="badge bg-dev ml-1">Developing (40-64%)</span><span class="badge bg-prof ml-1">Proficient (65-84%)</span><span class="badge bg-exem ml-1">Exemplary (85%+)</span></div>
                    <div class="text-right"><div>Generated on: ${new Date().toLocaleDateString()}</div></div>
                </div>
                <div class="signature-grid">
                    <div><div class="h-10"></div><div class="sign-line">Class Teacher</div></div>
                    <div><div class="h-10"></div><div class="sign-line">Parent / Guardian</div></div>
                    <div><div class="h-10"></div><div class="sign-line">Headmaster / Principal</div></div>
                </div>
            </div>`;
        }

        function printCard() { if(document.getElementById('cardsContainer').innerHTML.trim() === "") { alert("Please search for students first."); return; } window.print(); }
    </script>
</body>
</html>